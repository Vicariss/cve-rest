from flask import Blueprint, abort, jsonify, current_app, request, redirect, url_for
import pymongo
from application import db_client


main_bp = Blueprint("main_bp", __name__)


@main_bp.route("/")
def home_redirect():
    return redirect(url_for("main_bp.get_cve"))


@main_bp.route('/cve', methods=["GET"])
def get_cve():

    # get values from query string
    amount = request.args.get("amount", type=int)
    
    # TODO - implement sorting
    # sort = request.args.get("sort", type=str) sort=asc
    
    try:
        """ mongodb connection """
        db = db_client.cve_db
        collection = db.cve
        
        # base query, if user doesn't specify amount return 10 CVE
        results = collection.find().limit(10).sort("date", pymongo.DESCENDING) 

        # if user specify amount of CVEs to get
        if amount:
            if amount > 2000:  # only 2000 CVEs at once
                return "You've requested too many CVEs at once. Max is 2000."
            results = collection.find().limit(amount).sort("date", pymongo.DESCENDING)  # if user specify amount, limit query
 
        cve_data = []

        for cve in results:
            cve_object = {
                "title": cve["title"],
                "content": cve["content"],
                "date": cve["date"],
                "references": cve["references"]         
            }
            cve_data.append(cve_object)

        return {"data": cve_data}

    except Exception as e:
        print(e)

